apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-with-vpn
  labels:
    app: iotistic-agent
    feature: vpn-client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: iotistic-agent
  template:
    metadata:
      labels:
        app: iotistic-agent
    spec:
      containers:
      - name: agent
        image: iotistic/agent:latest
        env:
        # Agent configuration
        - name: NODE_ENV
          value: "production"
        - name: API_PORT
          value: "3002"
        - name: DEVICE_ID
          value: "device-12345"
        - name: CUSTOMER_ID
          value: "customer-abcdef"
        
        # VPN configuration
        - name: VPN_ENABLED
          value: "true"
        - name: BILLING_SERVICE_URL
          value: "https://billing.iotistic.cloud"
        - name: DEVICE_API_KEY
          valueFrom:
            secretKeyRef:
              name: device-credentials
              key: api-key
        - name: VPN_BINARY_PATH
          value: "/usr/sbin/openvpn"
        - name: VPN_LOG_LEVEL
          value: "info"
        
        ports:
        - containerPort: 3002
          name: api
        
        # Security context for VPN operations
        securityContext:
          capabilities:
            add:
            - NET_ADMIN    # Required for VPN network configuration
            - NET_RAW      # Required for raw socket operations
          allowPrivilegeEscalation: true
          runAsNonRoot: false  # Required for network operations
        
        # Volume mounts
        volumeMounts:
        - name: agent-data
          mountPath: /app/data
        - name: dev-net-tun
          mountPath: /dev/net/tun
          readOnly: false
        
        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 3002
          initialDelaySeconds: 30
          periodSeconds: 30
        
        readinessProbe:
          httpGet:
            path: /ready
            port: 3002
          initialDelaySeconds: 10
          periodSeconds: 10
        
        # Resource limits
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      
      # Volumes
      volumes:
      - name: agent-data
        persistentVolumeClaim:
          claimName: agent-data-pvc
      - name: dev-net-tun
        hostPath:
          path: /dev/net/tun
          type: CharDevice
      
      # Service account (if needed for additional permissions)
      serviceAccountName: iotistic-agent

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: agent-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard

---
apiVersion: v1
kind: Secret
metadata:
  name: device-credentials
type: Opaque
data:
  # Base64 encoded device API key
  api-key: eW91ci1kZXZpY2UtYXBpLWtleQ==  # "your-device-api-key"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: iotistic-agent

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: iotistic-agent-role
rules:
# Add any required permissions for the agent
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: iotistic-agent-binding
subjects:
- kind: ServiceAccount
  name: iotistic-agent
roleRef:
  kind: Role
  name: iotistic-agent-role
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: Service
metadata:
  name: agent-service
  labels:
    app: iotistic-agent
spec:
  selector:
    app: iotistic-agent
  ports:
  - name: api
    port: 3002
    targetPort: 3002
  type: ClusterIP