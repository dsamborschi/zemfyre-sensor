{{- if .Values.vpn.enabled }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "customer-instance.fullname" . }}-vpn-data
  labels:
    {{- include "customer-instance.labels" . | nindent 4 }}
    app.kubernetes.io/component: vpn
spec:
  accessModes:
    - ReadWriteOnce
  {{- if .Values.vpn.persistence.storageClass }}
  storageClassName: {{ .Values.vpn.persistence.storageClass }}
  {{- end }}
  resources:
    requests:
      storage: {{ .Values.vpn.persistence.size }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "customer-instance.fullname" . }}-vpn
  labels:
    {{- include "customer-instance.labels" . | nindent 4 }}
    app.kubernetes.io/component: vpn
spec:
  type: {{ .Values.vpn.serviceType }}
  {{- if eq .Values.vpn.serviceType "LoadBalancer" }}
  # LoadBalancer for production - gets external IP
  externalTrafficPolicy: Local
  {{- end }}
  ports:
  - name: openvpn
    port: {{ .Values.vpn.ports.openvpn }}
    targetPort: openvpn
    protocol: UDP
    {{- if and (eq .Values.vpn.serviceType "NodePort") .Values.vpn.nodePorts.openvpn }}
    nodePort: {{ .Values.vpn.nodePorts.openvpn }}
    {{- end }}
  - name: management
    port: {{ .Values.vpn.ports.management }}
    targetPort: management
    protocol: TCP
    {{- if and (eq .Values.vpn.serviceType "NodePort") .Values.vpn.nodePorts.management }}
    nodePort: {{ .Values.vpn.nodePorts.management }}
    {{- end }}
  - name: ca-cert
    port: {{ .Values.vpn.ports.caCert }}
    targetPort: ca-cert
    protocol: TCP
    {{- if and (eq .Values.vpn.serviceType "NodePort") .Values.vpn.nodePorts.caCert }}
    nodePort: {{ .Values.vpn.nodePorts.caCert }}
    {{- end }}
  selector:
    {{- include "customer-instance.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: vpn
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "customer-instance.fullname" . }}-vpn
  labels:
    {{- include "customer-instance.labels" . | nindent 4 }}
    app.kubernetes.io/component: vpn
spec:
  replicas: 1
  strategy:
    type: Recreate  # Can't have multiple VPN servers sharing same port
  selector:
    matchLabels:
      {{- include "customer-instance.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: vpn
  template:
    metadata:
      labels:
        {{- include "customer-instance.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: vpn
    spec:
      restartPolicy: Always
      securityContext:
        # OpenVPN requires CAP_NET_ADMIN to create tun device
        # Run as non-root but with specific capabilities
        fsGroup: 1000
      containers:
      - name: vpn-server
        image: "{{ .Values.vpn.image.repository }}:{{ .Values.vpn.image.tag }}"
        command: ["/docker-entrypoint.sh", "start"]
        securityContext:
          capabilities:
            add:
              - NET_ADMIN  # Required for tun device and routing
          privileged: false  # Don't need full privileged mode
        ports:
        - name: openvpn
          containerPort: {{ .Values.vpn.ports.openvpn }}
          protocol: UDP
        - name: management
          containerPort: {{ .Values.vpn.ports.management }}
          protocol: TCP
        - name: ca-cert
          containerPort: {{ .Values.vpn.ports.caCert }}
          protocol: TCP
        env:
        - name: VPN_SUBNET
          value: {{ .Values.vpn.network.subnet | quote }}
        - name: VPN_NETMASK
          value: {{ .Values.vpn.network.netmask | quote }}
        - name: PKI_COUNTRY
          value: {{ .Values.vpn.pki.country | quote }}
        - name: PKI_PROVINCE
          value: {{ .Values.vpn.pki.province | quote }}
        - name: PKI_CITY
          value: {{ .Values.vpn.pki.city | quote }}
        - name: PKI_ORG
          value: {{ .Values.vpn.pki.org | quote }}
        - name: PKI_OU
          value: {{ .Values.vpn.pki.orgUnit | quote }}
        - name: PKI_CN
          value: {{ .Values.vpn.pki.commonName | default (printf "vpn-%s" .Values.customer.id) | quote }}
        - name: CUSTOMER_ID
          value: {{ .Values.customer.id | quote }}
        # K8s network CIDRs for routing (optional - defaults in server.conf)
        # Override these if your cluster uses different ranges
        - name: K8S_SERVICE_CIDR
          value: "10.96.0.0/12"  # K8s ClusterIP service network
        - name: K8S_POD_CIDR
          value: "10.244.0.0/16"  # K8s pod network (optional)
        volumeMounts:
        - name: vpn-data
          mountPath: /etc/openvpn/pki
          subPath: pki
        - name: vpn-data
          mountPath: /var/log/openvpn
          subPath: logs
        resources:
          {{- toYaml .Values.vpn.resources | nindent 10 }}
        livenessProbe:
          tcpSocket:
            port: management
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          tcpSocket:
            port: management
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: vpn-data
        persistentVolumeClaim:
          claimName: {{ include "customer-instance.fullname" . }}-vpn-data
{{- end }}
