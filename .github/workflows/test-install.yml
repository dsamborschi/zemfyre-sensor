name: Test Full Installation

on: 
  push:
    branches:
      - master
    paths:
      - 'bin/install.sh'
      - 'bin/upgrade_containers.sh'
      - 'docker-compose.yml.tmpl'
      - 'docker-compose.dev.yml'
      - 'agent/**'
      - 'mosquitto/**'
      - 'nodered/**'
      - 'influxdb/**'
      - 'grafana/**'
      - 'nginx/**'
      - 'api/**'
      - 'admin/**'
      - 'ansible/**'

jobs:
  test-installation:
    name: Test Full Installation
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - board: pi4
            platform: linux/arm64/v8
            target_arch: arm64
          - board: x86
            platform: linux/amd64
            target_arch: amd64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache/${{ matrix.board }}
          key: buildx-full-${{ matrix.board }}-${{ github.sha }}
          restore-keys: |
            buildx-full-${{ matrix.board }}-

      - name: Prepare test environment
        run: |
          echo "ðŸ”§ Setting up test environment for ${{ matrix.board }}, arch ${{ matrix.target_arch }}"
          
          # Create minimal .env for testing
          cat > .env <<EOF
          # Test Environment
          DEVICE_UUID=test-device-${{ matrix.board }}
          TARGET_ARCH=${{ matrix.target_arch }}
          MODE=build
          EOF
          
          echo "âœ… Environment configured"

      - name: Run installation script
        run: |
          echo "ðŸš€ Running bin/install.sh for ${{ matrix.board }}, arch ${{ matrix.target_arch }}..."
          
          # Check if install script exists
          if [ ! -f "bin/install.sh" ]; then
            echo "âŒ bin/install.sh not found"
            exit 1
          fi
          
          # Make it executable
          chmod +x bin/install.sh
          
          # Set architecture and mode for install script
          export TARGET_ARCH=${{ matrix.target_arch }}
          export PLATFORM=${{ matrix.platform }}
          export MODE=build
          export DEBIAN_FRONTEND=noninteractive
          
          # Run the installation script with master branch (non-interactive)
          export TERM=xterm

          bash bin/install.sh master
          
          echo "âœ… Installation completed"
    
      - name: Debug compose location
        run: |
          echo "ðŸ” Listing possible compose files:"
          find . -maxdepth 3 -name "docker-compose*.yml" -o -name "docker-compose*.yaml"


      - name: Verify installation
        run: |
          echo "ðŸ“¦ Checking running containers..."
          docker ps -a

          echo "â³ Waiting for services to be ready..."
          sleep 10
          echo "âœ… Installation verified"

      - name: Show installation logs
        if: always()
        run: |
          echo "ðŸŸ¢ Docker Containers (all):"
          docker ps -a || true
          echo ""

          echo "ðŸ“‹ Docker Images (iotistic):"
          docker images | grep iotistic || true
          echo ""

          echo "ðŸ“‹ Last 50 lines of logs per container:"
          for container in $(docker ps -q); do
            name=$(docker inspect --format='{{.Name}}' "$container" | sed 's|/||')
            echo "----- Logs for $name -----"
            docker logs --tail 50 "$container" || true
            echo ""
          done


      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker compose down -v 2>/dev/null || true
