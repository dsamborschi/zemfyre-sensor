# Docker Compose for Local VPN Testing
# Windows Agent → VPN Server → Services in Docker
#
# Usage:
#   docker-compose -f docker-compose.test-vpn.yml up -d
#
# This setup:
#   - Runs VPN server exposed on localhost:1194
#   - Runs MQTT, PostgreSQL, Redis, API in Docker network
#   - Windows agent connects to VPN at localhost:1194
#   - After VPN connection, agent can reach services via 10.8.0.1 gateway

services:
    postgres:
        image: postgres:16-alpine
        container_name: iotistic-postgres-test
        restart: unless-stopped
        environment:
            - POSTGRES_DB=iotistic
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
        ports:
            - "5432:5432"
        volumes:
            - iotistic-pg-test-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            iotistic-test-net:
                ipv4_address: 172.25.0.10

    redis:
        image: redis:7-alpine
        container_name: iotistic-redis-test
        restart: unless-stopped
        command: >
            redis-server
            --maxmemory 256mb
            --maxmemory-policy volatile-lru
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            iotistic-test-net:
                ipv4_address: 172.25.0.11

    mosquitto:
        image: iegomez/mosquitto-go-auth
        container_name: iotistic-mosquitto-test
        restart: unless-stopped
        ports:
            - "1883:1883"
            - "9001:9001"
        volumes:
            - ./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            iotistic-test-net:
                ipv4_address: 172.25.0.12

    api:
        build:
            context: ./api
            dockerfile: Dockerfile
        container_name: iotistic-api-test
        restart: unless-stopped
        environment:
            - PORT=3002
            - NODE_ENV=development
            - DB_HOST=172.25.0.10
            - DB_PORT=5432
            - DB_NAME=iotistic
            - DB_USER=postgres
            - DB_PASSWORD=postgres
            - DB_POOL_SIZE=20
            - MQTT_BROKER_URL=mqtt://172.25.0.12:1883
            - MQTT_USERNAME=admin
            - MQTT_PASSWORD=iotistic42!
            - REDIS_HOST=172.25.0.11
            - REDIS_PORT=6379
            - VPN_ENABLED=true
            - VPN_SERVER_HOST=localhost
            - VPN_SERVER_PORT=1194
            - VPN_CA_URL=http://172.25.0.20:8080
        ports:
            - "3002:3002"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            mosquitto:
                condition: service_started
        networks:
            iotistic-test-net:
                ipv4_address: 172.25.0.13

    vpn-server:
        build:
            context: ./vpn-server
            dockerfile: Dockerfile
        container_name: iotistic-vpn-test
        privileged: true
        cap_add:
            - NET_ADMIN
            - SYS_MODULE
        restart: unless-stopped
        ports:
            - "1194:1194/udp"  # OpenVPN - Windows agent connects here
            - "3200:3200/tcp"  # API Server
            - "7505:7505/tcp"  # Management interface
            - "8080:8080/tcp"  # CA Certificate download
        volumes:
            - vpn-test-config:/etc/openvpn
            - vpn-test-logs:/var/log/openvpn
            - ./vpn-server/config:/etc/openvpn/config:ro
            - ./vpn-server/scripts:/etc/openvpn/scripts:ro
        environment:
            - VPN_SERVER_HOST=localhost
            - VPN_SERVER_PORT=1194
            # VPN subnet: 10.8.0.0/16
            - VPN_SUBNET=10.8.0.0
            - VPN_NETMASK=255.255.0.0
            # Push routes to VPN clients for accessing Docker services
            - VPN_ROUTE_1=172.25.0.0 255.255.255.0  # Docker network
            - DATABASE_URL=postgresql://postgres:postgres@172.25.0.10:5432/iotistic
            - REDIS_URL=redis://172.25.0.11:6379
            - API_PORT=3200
            - LOG_LEVEL=debug
            - NODE_ENV=development
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            iotistic-test-net:
                ipv4_address: 172.25.0.20
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3200/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

volumes:
    iotistic-pg-test-data:
        driver: local
    vpn-test-config:
        driver: local
    vpn-test-logs:
        driver: local

networks:
    iotistic-test-net:
        driver: bridge
        ipam:
            config:
                - subnet: 172.25.0.0/24
                  gateway: 172.25.0.1
