# OpenVPN Server Configuration for LOCAL TESTING
# Windows Agent → VPN in Docker Desktop → Services in Docker

port 1194
proto udp
dev tun
topology subnet

# VPN network: 10.8.0.0/16
server 10.8.0.0 255.255.0.0
ifconfig-pool-persist /var/log/openvpn/ipp.txt

# PKI Certificates
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/issued/server.crt
key /etc/openvpn/pki/private/server.key
dh /etc/openvpn/pki/dh.pem
crl-verify /etc/openvpn/pki/crl.pem

# Encryption
cipher AES-256-GCM
auth SHA256
tls-version-min 1.2
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384

# Allow inter-client communication
client-to-client

# Client configuration directory
client-config-dir /etc/openvpn/ccd

# Routes for Docker test network
# Push route to Docker network (172.25.0.0/24) so Windows agent can reach services
push "route 172.25.0.0 255.255.255.0"

# DNS servers (optional - for hostname resolution)
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"

# Connection management
keepalive 10 120
ping-timer-rem
persist-key
persist-tun

# Compression
comp-lzo adaptive
push "comp-lzo adaptive"

# Logging
status /var/log/openvpn/openvpn-status.log 10
log /var/log/openvpn/openvpn.log
verb 4  # Debug level for testing
mute 20

# Management interface
management 0.0.0.0 7505

# Scripts
script-security 2
client-connect /etc/openvpn/scripts/client-connect.sh
client-disconnect /etc/openvpn/scripts/client-disconnect.sh
up /etc/openvpn/scripts/server-up.sh

# Performance
sndbuf 0
rcvbuf 0
push "sndbuf 0"
push "rcvbuf 0"

# Allow duplicate CNs (for testing - remove in production)
duplicate-cn

# Max clients
max-clients 100

# Security
remote-cert-tls client
tls-auth /etc/openvpn/pki/ta.key 0
verify-client-cert require
