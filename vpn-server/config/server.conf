# OpenVPN Server Configuration for Iotistic Platform
# Based on Balena's VPN architecture with multi-tenant support

# Network Configuration
port 1194
proto udp
dev tun
topology subnet

# Server network and routing
server 10.8.0.0 255.255.0.0
ifconfig-pool-persist /var/log/openvpn/ipp.txt

# Certificate and encryption
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/issued/server.crt
key /etc/openvpn/pki/private/server.key
dh /etc/openvpn/pki/dh.pem

# Certificate Revocation List
crl-verify /etc/openvpn/pki/crl.pem

# Encryption settings
cipher AES-256-GCM
auth SHA256
tls-version-min 1.2
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384

# Client configuration
client-to-client
client-config-dir /etc/openvpn/ccd
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"

# Connection management
keepalive 10 120
ping-timer-rem
persist-key
persist-tun

# Compression
comp-lzo adaptive
push "comp-lzo adaptive"

# User and group (for security)
# Run as openvpn user (Alpine Linux doesn't have nogroup)
user openvpn
group openvpn

# Logging
status /var/log/openvpn/openvpn-status.log 10
log-append /var/log/openvpn/openvpn.log
verb 3
mute 20

# Management interface (for monitoring)
management 127.0.0.1 7505

# Scripts for connection events
script-security 2
client-connect /etc/openvpn/scripts/client-connect.sh
client-disconnect /etc/openvpn/scripts/client-disconnect.sh
up /etc/openvpn/scripts/server-up.sh
down /etc/openvpn/scripts/server-down.sh

# Performance tuning
sndbuf 0
rcvbuf 0
push "sndbuf 0"
push "rcvbuf 0"

# Duplicate certificate prevention
duplicate-cn

# Maximum number of concurrent clients
max-clients 1000

# Enable IPv6 support (optional)
# server-ipv6 fd00:10:8::/64
# push "route-ipv6 fd00:10:8::/64"

# Custom routes for Iotistic platform
# Push routes to client for accessing cloud services
push "route 10.244.0.0 255.255.0.0"  # K8s cluster network
push "route 172.17.0.0 255.255.0.0"  # Docker bridge network

# Security enhancements
remote-cert-tls client
tls-auth /etc/openvpn/pki/ta.key 0

# Prevent DNS leaks
push "block-outside-dns"

# Client certificate verification
verify-client-cert require

# Connection rate limiting
connect-freq 10 60

# Port sharing with web server (if needed)
# port-share 127.0.0.1 443