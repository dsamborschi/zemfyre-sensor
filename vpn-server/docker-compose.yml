version: '3.8'

services:
  vpn-server:
    build: .
    container_name: iotistic-vpn-server
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "1194:1194/udp"  # OpenVPN
      - "3200:3200/tcp"  # API Server
      - "7505:7505/tcp"  # Management interface
    volumes:
      - vpn-config:/etc/openvpn
      - vpn-logs:/var/log/openvpn
      - ./config:/etc/openvpn/config:ro
      - ./scripts:/etc/openvpn/scripts:ro
    environment:
      - VPN_SERVER_HOST=${VPN_SERVER_HOST:-localhost}
      - VPN_SERVER_PORT=${VPN_SERVER_PORT:-1194}
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:password@postgres:5432/iotistic_vpn}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - API_PORT=${API_PORT:-3200}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=${NODE_ENV:-development}
    networks:
      - iotistic-vpn
      - iotistic-backend
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres:
    image: postgres:15-alpine
    container_name: iotistic-vpn-postgres
    environment:
      - POSTGRES_DB=iotistic_vpn
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - vpn-postgres-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - iotistic-vpn
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: iotistic-vpn-redis
    volumes:
      - vpn-redis-data:/data
    networks:
      - iotistic-vpn
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Web UI for VPN management
  vpn-admin:
    image: nginx:alpine
    container_name: iotistic-vpn-admin
    ports:
      - "8080:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - iotistic-vpn
    restart: unless-stopped
    depends_on:
      - vpn-server

volumes:
  vpn-config:
    driver: local
  vpn-logs:
    driver: local
  vpn-postgres-data:
    driver: local
  vpn-redis-data:
    driver: local

networks:
  iotistic-vpn:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  iotistic-backend:
    external: true
    # Connect to existing Iotistic backend network