apiVersion: v1
kind: ConfigMap
metadata:
  name: vpn-config
  namespace: iotistic-vpn
  labels:
    app: vpn-server
    component: config
data:
  server.conf: |
    # OpenVPN Server Configuration for Iotistic Platform
    port 1194
    proto udp
    dev tun
    topology subnet
    
    # Server network and routing
    server 10.8.0.0 255.255.0.0
    ifconfig-pool-persist /var/log/openvpn/ipp.txt
    
    # Certificate and encryption
    ca /etc/openvpn/pki/ca.crt
    cert /etc/openvpn/pki/issued/vpn-server.crt
    key /etc/openvpn/pki/private/vpn-server.key
    dh /etc/openvpn/pki/dh.pem
    
    # Certificate Revocation List
    crl-verify /etc/openvpn/pki/crl.pem
    
    # Encryption settings
    cipher AES-256-GCM
    auth SHA256
    tls-version-min 1.2
    tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384
    
    # Client configuration
    client-to-client
    client-config-dir /etc/openvpn/ccd
    push "redirect-gateway def1 bypass-dhcp"
    push "dhcp-option DNS 8.8.8.8"
    push "dhcp-option DNS 8.8.4.4"
    
    # Connection management
    keepalive 10 120
    ping-timer-rem
    persist-key
    persist-tun
    
    # Compression
    comp-lzo adaptive
    push "comp-lzo adaptive"
    
    # User and group (for security)
    user nobody
    group nogroup
    
    # Logging
    status /var/log/openvpn/openvpn-status.log 10
    log-append /var/log/openvpn/openvpn.log
    verb 3
    mute 20
    
    # Management interface (for monitoring)
    management 127.0.0.1 7505
    
    # Scripts for connection events
    script-security 2
    client-connect /etc/openvpn/scripts/client-connect.sh
    client-disconnect /etc/openvpn/scripts/client-disconnect.sh
    up /etc/openvpn/scripts/server-up.sh
    down /etc/openvpn/scripts/server-down.sh
    
    # Performance tuning
    sndbuf 0
    rcvbuf 0
    push "sndbuf 0"
    push "rcvbuf 0"
    
    # Duplicate certificate prevention
    duplicate-cn
    
    # Maximum number of concurrent clients
    max-clients 1000
    
    # Push routes to client for accessing cloud services
    push "route 10.244.0.0 255.255.0.0"
    push "route 172.17.0.0 255.255.0.0"
    
    # Security enhancements
    remote-cert-tls client
    tls-auth /etc/openvpn/pki/ta.key 0
    
    # Prevent DNS leaks
    push "block-outside-dns"
    
    # Client certificate verification
    verify-client-cert require
    
    # Connection rate limiting
    connect-freq 10 60

  client-template.conf: |
    # OpenVPN Client Configuration Template
    client
    dev tun
    proto udp
    remote VPN_SERVER_HOST VPN_SERVER_PORT
    resolv-retry infinite
    nobind
    persist-key
    persist-tun
    
    # Certificate and key (will be embedded)
    ca [inline]
    cert [inline]
    key [inline]
    tls-auth [inline] 1
    
    # Security settings
    remote-cert-tls server
    cipher AES-256-GCM
    auth SHA256
    tls-version-min 1.2
    
    # Compression
    comp-lzo adaptive
    
    # Logging
    verb 3
    mute 20
    
    # Auto-reconnection
    ping 10
    ping-restart 60
    ping-timer-rem
    persist-remote-ip
    
    # Performance
    sndbuf 0
    rcvbuf 0
    
    # Prevent DNS leaks
    block-outside-dns
    
    # Route all traffic through VPN (full tunnel)
    redirect-gateway def1

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vpn-scripts
  namespace: iotistic-vpn
  labels:
    app: vpn-server
    component: scripts
data:
  client-connect.sh: |
    #!/bin/bash
    # Called when a client connects
    
    # Extract device info from certificate
    DEVICE_ID=$(echo "$common_name" | sed 's/device-\([^-]*\)-.*/\1/')
    CUSTOMER_ID=$(echo "$common_name" | sed 's/device-[^-]*-\(.*\)/\1/')
    
    # Log connection
    echo "$(date): Client connected - CN=$common_name, IP=$ifconfig_pool_remote_ip, Real=$trusted_ip" >> /var/log/openvpn/connections.log
    
    # Notify API server
    curl -s -X POST "http://localhost:3200/api/internal/client-connect" \
      -H "Content-Type: application/json" \
      -d "{
        \"commonName\": \"$common_name\",
        \"deviceId\": \"$DEVICE_ID\",
        \"customerId\": \"$CUSTOMER_ID\",
        \"vpnIP\": \"$ifconfig_pool_remote_ip\",
        \"realIP\": \"$trusted_ip\",
        \"timestamp\": \"$(date -Iseconds)\"
      }" &
    
    exit 0

  client-disconnect.sh: |
    #!/bin/bash
    # Called when a client disconnects
    
    # Extract device info from certificate
    DEVICE_ID=$(echo "$common_name" | sed 's/device-\([^-]*\)-.*/\1/')
    CUSTOMER_ID=$(echo "$common_name" | sed 's/device-[^-]*-\(.*\)/\1/')
    
    # Log disconnection
    echo "$(date): Client disconnected - CN=$common_name, IP=$ifconfig_pool_remote_ip, Bytes RX=$bytes_received, TX=$bytes_sent" >> /var/log/openvpn/connections.log
    
    # Notify API server
    curl -s -X POST "http://localhost:3200/api/internal/client-disconnect" \
      -H "Content-Type: application/json" \
      -d "{
        \"commonName\": \"$common_name\",
        \"deviceId\": \"$DEVICE_ID\",
        \"customerId\": \"$CUSTOMER_ID\",
        \"vpnIP\": \"$ifconfig_pool_remote_ip\",
        \"realIP\": \"$trusted_ip\",
        \"bytesReceived\": \"$bytes_received\",
        \"bytesSent\": \"$bytes_sent\",
        \"timestamp\": \"$(date -Iseconds)\"
      }" &
    
    exit 0

  server-up.sh: |
    #!/bin/bash
    # Called when OpenVPN server starts
    
    echo "$(date): OpenVPN server started" >> /var/log/openvpn/server.log
    
    # Set up iptables rules
    iptables -t nat -A POSTROUTING -s 10.8.0.0/16 -j MASQUERADE
    iptables -A FORWARD -i tun0 -j ACCEPT
    iptables -A FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
    iptables -A FORWARD -i eth0 -o tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT
    
    echo "IPTables rules configured"
    
    exit 0

  server-down.sh: |
    #!/bin/bash
    # Called when OpenVPN server stops
    
    echo "$(date): OpenVPN server stopped" >> /var/log/openvpn/server.log
    
    # Clean up iptables rules
    iptables -t nat -D POSTROUTING -s 10.8.0.0/16 -j MASQUERADE 2>/dev/null || true
    iptables -D FORWARD -i tun0 -j ACCEPT 2>/dev/null || true
    iptables -D FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || true
    iptables -D FORWARD -i eth0 -o tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || true
    
    echo "IPTables rules cleaned up"
    
    exit 0

---
apiVersion: v1
kind: Secret
metadata:
  name: vpn-secrets
  namespace: iotistic-vpn
  labels:
    app: vpn-server
    component: secrets
type: Opaque
data:
  # Base64 encoded values - replace with actual values
  database-url: cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBhc3N3b3JkQHBvc3RncmVzOjU0MzIvaW90aXN0aWNfdnBu
  redis-url: cmVkaXM6Ly9yZWRpczoxMjM0NQ==
  jwt-secret: eW91ci1zdXBlci1zZWNyZXQtand0LWtleS1oZXJl