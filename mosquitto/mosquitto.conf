# Mosquitto configuration with Go-Auth plugin
# PostgreSQL backend for authentication and ACL

# Basic Mosquitto settings
listener 1883 0.0.0.0
protocol mqtt

listener 9001 0.0.0.0
protocol websockets

# Disable anonymous access (require authentication)
allow_anonymous false

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_type debug

# Load Go-Auth plugin
auth_plugin /mosquitto/go-auth.so

# Backend configuration
auth_opt_backends postgres

# PostgreSQL connection settings
auth_opt_pg_host postgres
auth_opt_pg_port 5432
auth_opt_pg_dbname iotistic
auth_opt_pg_user postgres
auth_opt_pg_password postgres
auth_opt_pg_sslmode disable

# User authentication query
# Returns password_hash for the given username
auth_opt_pg_userquery SELECT password_hash FROM mqtt_users WHERE username = $1 AND is_active = true LIMIT 1

# ACL check query for mosquitto-go-auth with PostgreSQL
# Parameters passed by mosquitto-go-auth: $1 = username, $2 = topic, $3 = clientid, $4 = acc
# BUT: PostgreSQL backend only passes $1 (username) and $2 (acc) 
# The plugin will pattern-match returned topics against the requested topic
# access column values: 1=read, 2=write, 3=read+write, 4=subscribe
auth_opt_pg_aclquery SELECT topic FROM mqtt_acls WHERE username = $1 AND (access & $2) != 0

# Superuser query (optional - returns 1 if user is superuser)
auth_opt_pg_superquery SELECT COUNT(*) FROM mqtt_users WHERE username = $1 AND is_superuser = true

# Password hashing configuration for mosquitto-go-auth
auth_opt_hasher bcrypt
auth_opt_hasher_cost 10
auth_opt_hasher_salt_size 16

# Cache settings (optional - improves performance)
# auth_opt_cache true
# auth_opt_cache_reset true
# auth_opt_cache_ttl 300

# Logging level (debug for troubleshooting, change to info in production)
auth_opt_log_level debug
auth_opt_log_dest stdout
