# Mosquitto configuration with Go-Auth plugin
# HTTP backend with Redis caching for authentication and ACL
# 
# This is an OPTIONAL configuration that adds Redis caching on top of HTTP auth.
# Use this when you want to reduce load on the API by caching auth results.
#
# To enable: 
#   1. Uncomment redis service in docker-compose.yml if not already running
#   2. Update mosquitto service to use this config file instead of mosquitto.conf
#   3. Restart mosquitto: docker-compose restart mosquitto

# Basic Mosquitto settings
listener 1883 0.0.0.0
protocol mqtt

listener 9001 0.0.0.0
protocol websockets

# Disable anonymous access (require authentication)
allow_anonymous false

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_type debug

# Load Go-Auth plugin
auth_plugin /mosquitto/go-auth.so

# Backend configuration - HTTP + Redis cache
# Cache layer sits in front of HTTP backend for performance
auth_opt_backends http

# HTTP backend settings
auth_opt_http_host api
auth_opt_http_port 3002
auth_opt_http_getuser_uri /mosquitto-auth/user
auth_opt_http_superuser_uri /mosquitto-auth/superuser
auth_opt_http_aclcheck_uri /mosquitto-auth/acl
auth_opt_http_method POST
auth_opt_http_request_type json
auth_opt_http_response_mode status
auth_opt_http_timeout 5000
auth_opt_http_retry_count 3

# Password hashing configuration
auth_opt_hasher bcrypt
auth_opt_hasher_cost 10
auth_opt_hasher_salt_size 16

# Redis cache configuration
# Enable caching to reduce API load
auth_opt_cache true

# Cache backend (redis)
auth_opt_cache_type redis

# Redis connection
auth_opt_cache_host redis
auth_opt_cache_port 6379
# auth_opt_cache_password <password>  # Uncomment if Redis has password
auth_opt_cache_db 1  # Use DB 1 for auth cache (DB 0 for application)

# Cache TTL settings (in seconds)
auth_opt_auth_cache_seconds 300      # User authentication cache: 5 minutes
auth_opt_acl_cache_seconds 300       # ACL cache: 5 minutes  
auth_opt_auth_jitter_seconds 10      # Random jitter to prevent cache stampede

# Cache reset behavior
# When true, clears cache on auth failure (prevents cached denials)
auth_opt_cache_reset true

# Cache key prefix (optional - useful for multi-tenant setups)
# auth_opt_cache_prefix mosquitto:

# Logging level (debug for troubleshooting, change to info in production)
auth_opt_log_level debug
auth_opt_log_dest stdout

