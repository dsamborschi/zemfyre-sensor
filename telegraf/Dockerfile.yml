# ---------- 1️⃣ Build stage ----------
FROM golang:1.22 AS builder

# Accept plugin filters as build arguments
ARG TELEGRAF_VERSION=1.36.2
ARG INPUT_PLUGINS=""
ARG OUTPUT_PLUGINS=""
ARG PROCESSOR_PLUGINS=""
ARG AGGREGATOR_PLUGINS=""

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends make git ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Clone specific version of Telegraf source
RUN git clone --depth 1 --branch v${TELEGRAF_VERSION} https://github.com/influxdata/telegraf.git .

# Build custom Telegraf binary dynamically
RUN make custom-builder && \
    ./custom-builder \
      --input-filter "${INPUT_PLUGINS}" \
      --output-filter "${OUTPUT_PLUGINS}" \
      --processor-filter "${PROCESSOR_PLUGINS}" \
      --aggregator-filter "${AGGREGATOR_PLUGINS}" \
      --output /telegraf

# ---------- 2️⃣ Runtime stage ----------
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Copy the custom-built Telegraf binary
COPY --from=builder /telegraf /usr/bin/telegraf

# Optional: default config
COPY telegraf.conf /etc/telegraf/telegraf.conf

EXPOSE 8125/udp 8092/udp 8094

ENTRYPOINT ["telegraf"]
