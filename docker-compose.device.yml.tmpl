services:
    agent:
        container_name: agent
        image: iotistic/agent:${DOCKER_TAG}-${DEVICE_TYPE}
        build:
            context: ./agent
            dockerfile: Dockerfile
        privileged: true
        pid: "host"
        tty: true
        restart: always
        network_mode: host
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - agent-data:/app/data
        environment:
          - NODE_ENV=production
          - DATABASE_PATH=/app/data/database.sqlite
          - MQTT_BROKER=mqtt://localhost:5883
          - ENABLE_FILE_LOGGING=false
          - MAX_LOGS=500
          - CLOUD_API_ENDPOINT=${CLOUD_API_ENDPOINT:-}
          - LOG_COMPRESSION=true
          - PROVISIONING_API_KEY=${PROVISIONING_API_KEY:-}
          - DEVICE_API_PORT=48484
          # SSH Reverse Tunnel (Remote Access)
          - ENABLE_REMOTE_ACCESS=${ENABLE_REMOTE_ACCESS:-false}
          - CLOUD_HOST=${CLOUD_HOST:-}
          - CLOUD_SSH_PORT=${CLOUD_SSH_PORT:-22}
          - SSH_TUNNEL_USER=${SSH_TUNNEL_USER:-tunnel}
          - SSH_KEY_PATH=${SSH_KEY_PATH:-/app/data/ssh/id_rsa}
          - SSH_AUTO_RECONNECT=${SSH_AUTO_RECONNECT:-true}
          - SSH_RECONNECT_DELAY=${SSH_RECONNECT_DELAY:-5000}

    dashboard:
        container_name: dashboard
        image: iotistic/dashboard:${DOCKER_TAG}-${DEVICE_TYPE}
        build:
            context: ./dashboard
            dockerfile: Dockerfile
        restart: always
        ports:
          - "${DASHBOARD_PORT_EXT:-3000}:80"
        networks:
          - iotistic-net
        healthcheck:
          test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
          interval: 30s
          timeout: 3s
          retries: 3
          start_period: 5s
volumes:
  agent-data:
    name: agent-data
    driver: local
 
networks:
  iotistic-net:
    driver: bridge


