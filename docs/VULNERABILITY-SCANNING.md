# Vulnerability Scanning Integration

## Overview

The Application Manager includes a vulnerability scanning feature that displays known CVEs (Common Vulnerabilities and Exposures) for container images. Currently, it uses mock data for demonstration purposes.

## Current Implementation

**Location**: `admin/src/pages/applications/ApplicationsPage.vue`

**Function**: `scanImageVulnerabilities(imageName: string)`

**Features**:
- Displays vulnerability count by severity (Critical, High, Medium, Low)
- Shows detailed vulnerability list with CVE IDs, packages, and fixability status
- Links to NIST National Vulnerability Database for each CVE
- Auto-loads when "Vulnerabilities" tab is opened

## Integration Options

### 1. Trivy (Recommended - Open Source)

**Why Trivy?**
- ✅ Free and open source
- ✅ Comprehensive vulnerability database
- ✅ Easy Docker integration
- ✅ Fast scanning
- ✅ Supports multiple package managers

**Docker Integration**:

```yaml
# Add to docker-compose.yml
trivy:
  image: aquasec/trivy:latest
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - trivy-cache:/root/.cache/
  networks:
    - zemfyre-net
  command: server --listen 0.0.0.0:8080
  ports:
    - "8080:8080"
```

**API Endpoint**:
```bash
# Scan an image
curl -X POST http://trivy:8080/scan \
  -H "Content-Type: application/json" \
  -d '{"image":"nginx:alpine"}'
```

**Frontend Integration**:

```typescript
const scanImageVulnerabilities = async (imageName: string) => {
  loadingVulnerabilities.value = true
  vulnerabilityError.value = null
  vulnerabilities.value = []

  try {
    const response = await fetch(`http://localhost:8080/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageName })
    })

    const data = await response.json()
    
    // Parse Trivy results
    const vulns: any[] = []
    if (data.Results) {
      for (const result of data.Results) {
        if (result.Vulnerabilities) {
          for (const vuln of result.Vulnerabilities) {
            vulns.push({
              id: vuln.VulnerabilityID,
              severity: vuln.Severity,
              package: `${result.Type} / ${vuln.PkgName} / ${vuln.InstalledVersion}`,
              fixable: !!vuln.FixedVersion,
            })
          }
        }
      }
    }
    
    vulnerabilities.value = vulns
  } catch (error) {
    console.error('Error scanning vulnerabilities:', error)
    vulnerabilityError.value = 'Failed to scan for vulnerabilities.'
  } finally {
    loadingVulnerabilities.value = false
  }
}
```

### 2. Grype (Anchore - Open Source)

**Why Grype?**
- ✅ Free and open source
- ✅ Fast and accurate
- ✅ Multiple output formats
- ✅ CLI-friendly

**Docker Integration**:

```yaml
# Add to docker-compose.yml
grype:
  image: anchore/grype:latest
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - grype-db:/home/grype/.cache/grype/db
  networks:
    - zemfyre-net
  entrypoint: ["/bin/sh"]
  command: ["-c", "while true; do sleep 3600; done"]
```

**Usage**:

```bash
# Scan via exec
docker exec grype grype nginx:alpine -o json
```

**Backend API Endpoint** (add to `application-manager/src/api/server.ts`):

```typescript
app.post('/api/v1/scan/:imageName', async (req, res) => {
  const { imageName } = req.params
  
  try {
    const result = await dockerManager.exec('grype', [
      'grype', imageName, '-o', 'json'
    ])
    
    const vulns = JSON.parse(result.stdout)
    res.json(vulns)
  } catch (error) {
    res.status(500).json({ error: 'Scan failed' })
  }
})
```

### 3. Docker Scout (Docker Official)

**Why Docker Scout?**
- ✅ Official Docker solution
- ✅ Integrated with Docker Hub
- ✅ Free tier available
- ⚠️ Requires Docker account

**CLI Usage**:

```bash
# Login required
docker scout cves nginx:alpine --format json
```

**Integration**: Similar to Grype, exec via Docker API

### 4. Snyk (Commercial with Free Tier)

**Why Snyk?**
- ✅ Excellent CVE database
- ✅ Developer-friendly
- ✅ Free for open source
- ⚠️ Requires API token

**API Integration**:

```typescript
const SNYK_API_TOKEN = process.env.SNYK_API_TOKEN

const scanImageVulnerabilities = async (imageName: string) => {
  const response = await fetch('https://snyk.io/api/v1/test/docker', {
    method: 'POST',
    headers: {
      'Authorization': `token ${SNYK_API_TOKEN}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ imageName })
  })
  
  const data = await response.json()
  // Parse Snyk response...
}
```

### 5. Clair (Quay - Open Source)

**Why Clair?**
- ✅ Open source
- ✅ Used by Quay.io
- ✅ REST API
- ⚠️ Complex setup

**Requires**:
- PostgreSQL database
- Clair service
- Indexer and matcher services

---

## Recommended Implementation Path

### Phase 1: Trivy Integration (Quick Win)

1. Add Trivy container to `docker-compose.yml`
2. Create API endpoint in application-manager
3. Update frontend to call real API
4. Test with common images

### Phase 2: Caching & Performance

1. Cache scan results in InfluxDB or SQLite
2. Background scanning for deployed images
3. Periodic re-scanning (daily)

### Phase 3: Alerting

1. Alert on critical vulnerabilities
2. MQTT notifications for new CVEs
3. Grafana dashboard for vulnerability trends

---

## Mock Data Structure

Current mock data format (matches Trivy output):

```typescript
interface Vulnerability {
  id: string          // CVE-2025-7783
  severity: string    // CRITICAL, HIGH, MEDIUM, LOW
  package: string     // npm / form-data / 2.3.3
  fixable: boolean    // Is a fix available?
}
```

---

## Testing

**Test with these images** (known vulnerabilities):

- `nginx:1.19` - Multiple CVEs
- `node:14-alpine` - Outdated Node.js
- `postgres:12` - Known vulnerabilities
- `ubuntu:18.04` - EOL, many CVEs

**Secure images** (minimal vulnerabilities):

- `nginx:alpine` - Latest Alpine
- `node:20-alpine` - Current LTS
- `distroless images` - Google's minimal images

---

## API Response Example

### Trivy JSON Output:

```json
{
  "SchemaVersion": 2,
  "ArtifactName": "nginx:alpine",
  "Results": [
    {
      "Target": "nginx:alpine (alpine 3.19.1)",
      "Type": "alpine",
      "Vulnerabilities": [
        {
          "VulnerabilityID": "CVE-2025-7783",
          "PkgName": "curl",
          "InstalledVersion": "8.12.1-r1",
          "FixedVersion": "8.12.2-r0",
          "Severity": "CRITICAL",
          "Title": "curl: buffer overflow in authentication"
        }
      ]
    }
  ]
}
```

---

## Security Considerations

1. **API Token Security**: Store Snyk/Docker Hub tokens in environment variables
2. **Rate Limiting**: Cache results to avoid API limits
3. **Access Control**: Only authenticated users should trigger scans
4. **Data Privacy**: Don't expose internal image names externally

---

## Resources

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Grype GitHub](https://github.com/anchore/grype)
- [Docker Scout](https://docs.docker.com/scout/)
- [Snyk API Docs](https://snyk.io/docs/api/)
- [NIST NVD](https://nvd.nist.gov/)

---

## Future Enhancements

- [ ] SBOM (Software Bill of Materials) generation
- [ ] License compliance scanning
- [ ] Secret detection in images
- [ ] Base image recommendations
- [ ] Automated remediation suggestions
- [ ] Integration with CI/CD pipelines
