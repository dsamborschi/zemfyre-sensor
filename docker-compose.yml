# Docker Compose configuration for Cloud API and PostgreSQL backend
# 
# Usage:
#   docker-compose -f docker-compose.cloud.yml up -d
#
# This stack provides:
#   - PostgreSQL 16 database for persistent device state storage
#   - Iotistic API server with Balena-style endpoints
#
# Environment variables (configure in .env):
#   - DB_PASSWORD=<password>    # PostgreSQL password
#   - DB_PORT_EXT=5432          # External PostgreSQL port
#   - API_PORT_EXT=3002         # External API port
#   - GRAFANA_API_TOKEN=<token> # For Grafana integration

services:
    agent-1:
            container_name: agent-1
            build:
                context: ./agent
                dockerfile: Dockerfile
            privileged: true
            pid: "host"
            tty: true
            restart: always
            network_mode: host
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-1-data:/app/data
            environment:
                - PORT=4002
                - DEVICE_API_PORT=48484
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - FORCE_COLOR=1
                - MQTT_BROKER_URL=mqtt://mosquitto:1883
                - MQTT_USERNAME=admin
                - MQTT_PASSWORD=iotistic42!
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=2000
                - METRICS_INTERVAL_MS=2000
                - LOG_COMPRESSION=true
                - PROVISIONING_API_KEY=708b51cbc9b5b515151fbb943ba9788ab6885d037455424b290f97d2077ae8c0
                - LICENSE_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqS6oN6f88fM0YkWE1rcu\nsUDStDBOnVSFjl2jvSwsb+2jb6dFESj+HJBREmwdtFJp1J9hS8PiNXs3PcsyGJi8\nGTYUhpy5Xv7I96A5krmRUfFxJylaS3wmMl55M19f2z0mi8CayhzXgmK3CKA+rLa+\nLC+CxpVIFMc88vJxkeC14W8Hh25wxxbXCTTtS702cjtVzDZSWuM/hIqlBAPKDfKo\nTp8otRyNJyutl1wwnF5mI/3sVyNMyEPzVG3H6y/3Kt4BYXyzt9CgMoGHCxLaQNxn\nz+kivnIY8PK2Ywii3OFkO47/+ZlV6+e6bny9hlvCkhU9DNfzoBb4YBAu4F62llLK\nlQIDAQAB\n-----END PUBLIC KEY-----
                - IOTISTIC_LICENSE_KEY=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJjdXN0b21lcklkIjoiY3VzdF85NWM3ZmIzNDU0NmE0Zjc2YjhhNjJkNDBiNDE3NThhNCIsImN1c3RvbWVyTmFtZSI6IlRlc3QgQ29ycCIsInBsYW4iOiJzdGFydGVyIiwiZmVhdHVyZXMiOnsibWF4RGV2aWNlcyI6MTAsImRhdGFSZXRlbnRpb25EYXlzIjozMCwiY2FuRXhwb3J0RGF0YSI6dHJ1ZSwiaGFzQWR2YW5jZWRBbGVydHMiOmZhbHNlLCJoYXNBcGlBY2Nlc3MiOnRydWUsImhhc01xdHRBY2Nlc3MiOnRydWUsImhhc0N1c3RvbUJyYW5kaW5nIjpmYWxzZX0sImxpbWl0cyI6eyJtYXhVc2VycyI6NSwibWF4QWxlcnRSdWxlcyI6MjUsIm1heERhc2hib2FyZHMiOjEwfSwidHJpYWwiOnsiaXNUcmlhbE1vZGUiOnRydWUsImV4cGlyZXNBdCI6IjIwMjUtMTEtMDRUMjM6NTM6MDguNTM2WiJ9LCJzdWJzY3JpcHRpb24iOnsic3RhdHVzIjoidHJpYWxpbmciLCJjdXJyZW50UGVyaW9kRW5kc0F0IjoiMjAyNS0xMS0wNFQyMzo1MzowOC41MzZaIn0sImlzc3VlZEF0IjoxNzYxMDkyMjkxLCJleHBpcmVzQXQiOjE3OTI2MjgyOTEsImlhdCI6MTc2MTA5MjI5MSwiZXhwIjoxNzkyNjI4MjkxfQ.Sqeb4-9vny_un74-M37RnsDTMS1sELPeE2fU951idhY3eNQWXAg6l-T3kx8NtMzHz90Ar4r2VD0l8eqCfZbMeQxIYIyxzyGkP6Fb12dJN-M1Y9wUtyee5C4UE61XGZYogPgzclMr8d9pvy3iKRga4yxi4XnZrCzId7PovXBdMS7AKXL4Pgf_BVL54kpT78-KshM-6GFCuRT35gHnbo1qv_gH5vTM80E1OQt-0YEkPXDEuc7CN3p4-wRtR0GEe_dbWkIBPKqTGsmS5vm_HJWTy67oojfF-3O5Oo6dNWYit5gikK_Cy3eUjdaQmEU-CN7mXGpKmVadb8zj8cHTTDRlJA
    agent-2:
            container_name: agent-2
            build:
                context: ./agent
                dockerfile: Dockerfile
            privileged: true
            pid: "host"
            tty: true
            restart: always
            network_mode: host
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-2-data:/app/data
            environment:
                - PORT=4002
                - DEVICE_API_PORT=48485
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - FORCE_COLOR=1
                - MQTT_BROKER_URL=mqtt://mosquitto:1883
                - MQTT_USERNAME=admin
                - MQTT_PASSWORD=iotistic42!
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=2000
                - METRICS_INTERVAL_MS=2000
                - LOG_COMPRESSION=true
                - PROVISIONING_API_KEY=7a4bfa93fc7094a8359812fc3046f5f03729ce34a76913fb6767a04dbf3a407e
                - LICENSE_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqS6oN6f88fM0YkWE1rcu\nsUDStDBOnVSFjl2jvSwsb+2jb6dFESj+HJBREmwdtFJp1J9hS8PiNXs3PcsyGJi8\nGTYUhpy5Xv7I96A5krmRUfFxJylaS3wmMl55M19f2z0mi8CayhzXgmK3CKA+rLa+\nLC+CxpVIFMc88vJxkeC14W8Hh25wxxbXCTTtS702cjtVzDZSWuM/hIqlBAPKDfKo\nTp8otRyNJyutl1wwnF5mI/3sVyNMyEPzVG3H6y/3Kt4BYXyzt9CgMoGHCxLaQNxn\nz+kivnIY8PK2Ywii3OFkO47/+ZlV6+e6bny9hlvCkhU9DNfzoBb4YBAu4F62llLK\nlQIDAQAB\n-----END PUBLIC KEY-----
                - IOTISTIC_LICENSE_KEY=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJjdXN0b21lcklkIjoiY3VzdF85NWM3ZmIzNDU0NmE0Zjc2YjhhNjJkNDBiNDE3NThhNCIsImN1c3RvbWVyTmFtZSI6IlRlc3QgQ29ycCIsInBsYW4iOiJzdGFydGVyIiwiZmVhdHVyZXMiOnsibWF4RGV2aWNlcyI6MTAsImRhdGFSZXRlbnRpb25EYXlzIjozMCwiY2FuRXhwb3J0RGF0YSI6dHJ1ZSwiaGFzQWR2YW5jZWRBbGVydHMiOmZhbHNlLCJoYXNBcGlBY2Nlc3MiOnRydWUsImhhc01xdHRBY2Nlc3MiOnRydWUsImhhc0N1c3RvbUJyYW5kaW5nIjpmYWxzZX0sImxpbWl0cyI6eyJtYXhVc2VycyI6NSwibWF4QWxlcnRSdWxlcyI6MjUsIm1heERhc2hib2FyZHMiOjEwfSwidHJpYWwiOnsiaXNUcmlhbE1vZGUiOnRydWUsImV4cGlyZXNBdCI6IjIwMjUtMTEtMDRUMjM6NTM6MDguNTM2WiJ9LCJzdWJzY3JpcHRpb24iOnsic3RhdHVzIjoidHJpYWxpbmciLCJjdXJyZW50UGVyaW9kRW5kc0F0IjoiMjAyNS0xMS0wNFQyMzo1MzowOC41MzZaIn0sImlzc3VlZEF0IjoxNzYxMDkyMjkxLCJleHBpcmVzQXQiOjE3OTI2MjgyOTEsImlhdCI6MTc2MTA5MjI5MSwiZXhwIjoxNzkyNjI4MjkxfQ.Sqeb4-9vny_un74-M37RnsDTMS1sELPeE2fU951idhY3eNQWXAg6l-T3kx8NtMzHz90Ar4r2VD0l8eqCfZbMeQxIYIyxzyGkP6Fb12dJN-M1Y9wUtyee5C4UE61XGZYogPgzclMr8d9pvy3iKRga4yxi4XnZrCzId7PovXBdMS7AKXL4Pgf_BVL54kpT78-KshM-6GFCuRT35gHnbo1qv_gH5vTM80E1OQt-0YEkPXDEuc7CN3p4-wRtR0GEe_dbWkIBPKqTGsmS5vm_HJWTy67oojfF-3O5Oo6dNWYit5gikK_Cy3eUjdaQmEU-CN7mXGpKmVadb8zj8cHTTDRlJA

    agent-3:
            container_name: agent-3
            build:
                context: ./agent
                dockerfile: Dockerfile
            privileged: true
            pid: "host"
            tty: true
            restart: always
            network_mode: host
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - agent-3-data:/app/data
            environment:
                - PORT=4002
                - DEVICE_API_PORT=48486
                - CLOUD_API_ENDPOINT=http://host.docker.internal:4002
                - NODE_ENV=development
                - FORCE_COLOR=1
                - MQTT_BROKER_URL=mqtt://mosquitto:1883
                - MQTT_USERNAME=admin
                - MQTT_PASSWORD=iotistic42!
                - MQTT_PERSIST_TO_DB=true
                - MQTT_DB_SYNC_INTERVAL=70000
                - REPORT_INTERVAL_MS=2000
                - METRICS_INTERVAL_MS=2000
                - LOG_COMPRESSION=true
                - PROVISIONING_API_KEY=d29ed8ef80e7753308237bdcb292d4f988eb77732bf907241308355bcd0558dd
                - LICENSE_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqS6oN6f88fM0YkWE1rcu\nsUDStDBOnVSFjl2jvSwsb+2jb6dFESj+HJBREmwdtFJp1J9hS8PiNXs3PcsyGJi8\nGTYUhpy5Xv7I96A5krmRUfFxJylaS3wmMl55M19f2z0mi8CayhzXgmK3CKA+rLa+\nLC+CxpVIFMc88vJxkeC14W8Hh25wxxbXCTTtS702cjtVzDZSWuM/hIqlBAPKDfKo\nTp8otRyNJyutl1wwnF5mI/3sVyNMyEPzVG3H6y/3Kt4BYXyzt9CgMoGHCxLaQNxn\nz+kivnIY8PK2Ywii3OFkO47/+ZlV6+e6bny9hlvCkhU9DNfzoBb4YBAu4F62llLK\nlQIDAQAB\n-----END PUBLIC KEY-----
                - IOTISTIC_LICENSE_KEY=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJjdXN0b21lcklkIjoiY3VzdF85NWM3ZmIzNDU0NmE0Zjc2YjhhNjJkNDBiNDE3NThhNCIsImN1c3RvbWVyTmFtZSI6IlRlc3QgQ29ycCIsInBsYW4iOiJzdGFydGVyIiwiZmVhdHVyZXMiOnsibWF4RGV2aWNlcyI6MTAsImRhdGFSZXRlbnRpb25EYXlzIjozMCwiY2FuRXhwb3J0RGF0YSI6dHJ1ZSwiaGFzQWR2YW5jZWRBbGVydHMiOmZhbHNlLCJoYXNBcGlBY2Nlc3MiOnRydWUsImhhc01xdHRBY2Nlc3MiOnRydWUsImhhc0N1c3RvbUJyYW5kaW5nIjpmYWxzZX0sImxpbWl0cyI6eyJtYXhVc2VycyI6NSwibWF4QWxlcnRSdWxlcyI6MjUsIm1heERhc2hib2FyZHMiOjEwfSwidHJpYWwiOnsiaXNUcmlhbE1vZGUiOnRydWUsImV4cGlyZXNBdCI6IjIwMjUtMTEtMDRUMjM6NTM6MDguNTM2WiJ9LCJzdWJzY3JpcHRpb24iOnsic3RhdHVzIjoidHJpYWxpbmciLCJjdXJyZW50UGVyaW9kRW5kc0F0IjoiMjAyNS0xMS0wNFQyMzo1MzowOC41MzZaIn0sImlzc3VlZEF0IjoxNzYxMDkyMjkxLCJleHBpcmVzQXQiOjE3OTI2MjgyOTEsImlhdCI6MTc2MTA5MjI5MSwiZXhwIjoxNzkyNjI4MjkxfQ.Sqeb4-9vny_un74-M37RnsDTMS1sELPeE2fU951idhY3eNQWXAg6l-T3kx8NtMzHz90Ar4r2VD0l8eqCfZbMeQxIYIyxzyGkP6Fb12dJN-M1Y9wUtyee5C4UE61XGZYogPgzclMr8d9pvy3iKRga4yxi4XnZrCzId7PovXBdMS7AKXL4Pgf_BVL54kpT78-KshM-6GFCuRT35gHnbo1qv_gH5vTM80E1OQt-0YEkPXDEuc7CN3p4-wRtR0GEe_dbWkIBPKqTGsmS5vm_HJWTy67oojfF-3O5Oo6dNWYit5gikK_Cy3eUjdaQmEU-CN7mXGpKmVadb8zj8cHTTDRlJA


    postgres:
        image: postgres:16-alpine
        container_name: iotistic-postgres
        restart: unless-stopped
        environment:
            - POSTGRES_DB=${POSTGRES_DB:-iotistic}
            - POSTGRES_USER=${POSTGRES_USER:-postgres}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
        ports:
            - "5432:5432"
        volumes:
            - iotistic-pg-data:/var/lib/postgresql/data
            - ./postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
            - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
        command: >
            postgres
            -c config_file=/etc/postgresql/postgresql.conf
            -c hba_file=/etc/postgresql/pg_hba.conf
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
           - iotistic-net

    redis:
        image: redis:7-alpine
        container_name: iotistic-redis
        restart: unless-stopped
        command: >
            redis-server
            --maxmemory 256mb
            --maxmemory-policy volatile-lru
            --save 60 1000
            --appendonly yes
        ports:
            - "${REDIS_PORT_EXT:-6379}:6379"
        volumes:
            - iotistic-redis-data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
           - iotistic-net

    # api:
    #     build:
    #         context: ./api
    #         dockerfile: Dockerfile
    #     container_name: iotistic-api
    #     restart: always
    #     tty: true
    #     stdin_open: true
    #     logging:
    #         driver: "json-file"
    #         options:
    #             max-size: "10m"
    #             max-file: "3"
    #     environment:
    #         - PORT=${PORT:-3002}
    #         - NODE_ENV=${NODE_ENV:-development}
    #         - DB_HOST=${DB_HOST:-postgres}
    #         - DB_PORT=${DB_PORT:-5432}
    #         - DB_NAME=${DB_NAME:-iotistic}
    #         - DB_USER=${DB_USER:-postgres}
    #         - DB_PASSWORD=${DB_PASSWORD:-postgres}
    #         - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
    #         - FORCE_COLOR=${FORCE_COLOR:-1}
    #         - MQTT_BROKER_URL=${MQTT_BROKER_URL:-mqtt://mosquitto:1883}
    #         - MQTT_USERNAME=${MQTT_USERNAME:-admin}
    #         - MQTT_PASSWORD=${MQTT_PASSWORD:-iotistic42!}
    #         - MQTT_PERSIST_TO_DB=${MQTT_PERSIST_TO_DB:-true}
    #         - MQTT_DB_SYNC_INTERVAL=${MQTT_DB_SYNC_INTERVAL:-10000}
    #         - LOG_COMPRESSION=${LOG_COMPRESSION:-true}
    #         - LICENSE_PUBLIC_KEY=${LICENSE_PUBLIC_KEY}
    #         - IOTISTIC_LICENSE_KEY=${IOTISTIC_LICENSE_KEY}
    #         - REDIS_HOST=${REDIS_HOST:-redis}
    #         - REDIS_PORT=${REDIS_PORT:-6379}
    #     ports:
    #         - "${API_PORT_EXT:-4002}:3002"
    #     healthcheck:
    #         test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
    #         interval: 10s
    #         timeout: 5s
    #         retries: 5
    #         start_period: 30s
    #     depends_on:
    #         postgres:
    #             condition: service_healthy
    #         redis:
    #             condition: service_healthy
    #     networks:
    #        - iotistic-net
    mosquitto:
        image: iegomez/mosquitto-go-auth
        restart: always
        container_name: iotistic-mosquitto
        ports:
          - "${MOSQUITTO_PORT_EXT:-5883}:1883"
          - "${MOSQUITTO_WS_PORT_EXT:-59002}:9001"
        volumes:
          - ./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf
        depends_on:
            postgres:
                condition: service_healthy
        networks:
           - iotistic-net

    # VPN Services - Commented out until TypeScript code is complete
    # Missing: vpn-server/src/vpn-server.ts implementation
    # TODO: Complete VPN server implementation before enabling
    vpn-server:
        build:
            context: ./vpn-server
            dockerfile: Dockerfile
        container_name: iotistic-vpn-server
        privileged: true
        cap_add:
            - NET_ADMIN
            - SYS_MODULE
        restart: unless-stopped
        ports:
            - "${VPN_SERVER_PORT:-1194}:1194/udp"  # OpenVPN
            - "${VPN_API_PORT:-3200}:3200/tcp"      # API Server
            - "${VPN_MGMT_PORT:-7505}:7505/tcp"     # Management interface
            - "${VPN_CA_PORT:-8080}:8080/tcp"       # CA Certificate Server
        volumes:
            - vpn-config:/etc/openvpn
            - vpn-logs:/var/log/openvpn
            - ./vpn-server/config:/etc/openvpn/config:ro
            - ./vpn-server/scripts:/etc/openvpn/scripts:ro
        environment:
            - VPN_SERVER_HOST=${VPN_SERVER_HOST:-localhost}
            - VPN_SERVER_PORT=${VPN_SERVER_PORT:-1194}
            - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${VPN_DB_NAME:-iotistic_vpn}
            - REDIS_URL=redis://redis:6379
            - API_PORT=${VPN_API_PORT:-3200}
            - LOG_LEVEL=${VPN_LOG_LEVEL:-info}
            - NODE_ENV=${NODE_ENV:-development}
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - iotistic-net
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3200/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
    
    # Protocol Simulators for Testing
    modbus-simulator:
        build:
            context: ./sensors/modbus-simulator
            dockerfile: Dockerfile
        container_name: iotistic-modbus-sim
        restart: unless-stopped
        ports:
            - "502:502"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"
    
    canbus-simulator:
        build:
            context: ./sensors/canbus-simulator
            dockerfile: Dockerfile
        container_name: iotistic-canbus-sim
        restart: unless-stopped
        ports:
            - "11898:11898"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"
    
    opcua-simulator:
        build:
            context: ./sensors/opcua-simulator
            dockerfile: Dockerfile
        container_name: iotistic-opcua-sim
        restart: unless-stopped
        ports:
            - "4840:4840"
        networks:
            - iotistic-net
        logging:
            driver: "json-file"
            options:
                max-size: "5m"
                max-file: "2"

volumes:
  agent-1-data:
    driver: local
  agent-2-data:
    driver: local
  agent-3-data:
    driver: local
  iotistic-pg-data:
    driver: local
  iotistic-redis-data:
    driver: local
  vpn-config:
    driver: local
  vpn-logs:
    driver: local
 
networks:
  iotistic-net:
    driver: bridge
