# License Audit Logging Testing Guide

This guide shows how to test the new license audit logging feature.

---

## Database Migration

First, apply the migration:

```powershell
# Connect to billing database
psql -h localhost -p 5432 -U postgres -d Iotistic_billing

# Run migration
\i billing/migrations/002_add_license_audit.sql

# Verify table exists
\dt license_history
\d license_history
```

---

## Test Scenarios

### 1. Generate License (Logs "generated" action)

```powershell
# Get license for customer
$customerId = "cust_95c7fb34546a4f76b8a62d40b417584"
$response = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/$customerId" -Method GET

Write-Host "License generated!"
Write-Host "License JWT: $($response.license.Substring(0,50))..."
```

**Expected**: New row in `license_history` with:
- `action = 'generated'`
- `license_hash` = SHA-256 of JWT (NOT the actual JWT)
- `metadata` contains features, limits, subscription status

### 2. View License History

```powershell
# Get history for customer
$history = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/$customerId/history" -Method GET

Write-Host "Total Generations: $($history.statistics.totalGenerations)"
Write-Host ""
Write-Host "Recent Activity:"
$history.history | Select-Object -First 5 | Format-Table action, plan, max_devices, generated_at
```

### 3. Upgrade Subscription (Logs "upgraded" action)

```powershell
# Upgrade from starter to professional
$upgradeBody = @{
    customer_id = $customerId
    new_plan = "professional"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "http://localhost:3100/api/subscriptions/upgrade" `
    -Method POST `
    -Body $upgradeBody `
    -ContentType "application/json"

Write-Host "Subscription upgraded!"

# Check history again
$history = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/$customerId/history" -Method GET
$history.history | Select-Object -First 1 | Format-List
```

**Expected**: New row with:
- `action = 'upgraded'`
- `metadata.oldPlan = 'starter'`
- `metadata.newPlan = 'professional'`
- Different `license_hash` (new JWT generated)

### 4. Revoke License (Logs "revoked" action)

```powershell
# Revoke license
$revokeBody = @{
    reason = "Customer requested cancellation"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/$customerId/revoke" `
    -Method POST `
    -Body $revokeBody `
    -ContentType "application/json"

# Check history
$history = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/$customerId/history" -Method GET
$history.history | Where-Object { $_.action -eq 'revoked' } | Format-List
```

**Expected**: Row with:
- `action = 'revoked'`
- `license_hash = 'revoked'`
- `metadata.reason = 'Customer requested cancellation'`

### 5. View Overall Statistics

```powershell
# Get stats across all customers
$stats = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/stats" -Method GET

Write-Host "Overall License Statistics:"
Write-Host "Total Generations: $($stats.totalGenerations)"
Write-Host ""
Write-Host "By Action:"
$stats.byAction | ConvertTo-Json
Write-Host ""
Write-Host "By Plan:"
$stats.byPlan | ConvertTo-Json
```

### 6. View Recent Activity (All Customers)

```powershell
# Get recent license generations
$recent = Invoke-RestMethod -Uri "http://localhost:3100/api/licenses/history/recent?limit=20" -Method GET

Write-Host "Recent License Activity (Last 20):"
$recent.history | Select-Object customer_id, email, action, plan, generated_at | Format-Table
```

---

## SQL Queries for Verification

```sql
-- View all license generations for a customer
SELECT * FROM license_history 
WHERE customer_id = 'cust_95c7fb34546a4f76b8a62d40b417584' 
ORDER BY generated_at DESC;

-- Count license generations by action
SELECT action, COUNT(*) as count 
FROM license_history 
GROUP BY action 
ORDER BY count DESC;

-- Find all plan upgrades in last 30 days
SELECT lh.*, c.email, c.company_name
FROM license_history lh
JOIN customers c ON lh.customer_id = c.customer_id
WHERE lh.action IN ('upgraded', 'downgraded')
  AND lh.generated_at > NOW() - INTERVAL '30 days'
ORDER BY lh.generated_at DESC;

-- Find customers with most license regenerations
SELECT customer_id, COUNT(*) as regenerations
FROM license_history
WHERE action = 'generated'
GROUP BY customer_id
ORDER BY regenerations DESC
LIMIT 10;

-- Verify license hash (debugging)
-- If customer reports issue, you can find when their license was generated
SELECT lh.*, c.email
FROM license_history lh
JOIN customers c ON lh.customer_id = c.customer_id
WHERE lh.license_hash = 'abc123...'  -- SHA-256 hash from customer
LIMIT 1;
```

---

## What Gets Logged

### ✅ Stored in Database (Metadata Only)

- Customer ID
- Action (generated, upgraded, downgraded, revoked)
- Plan name
- Max devices
- License hash (SHA-256 of JWT)
- Timestamp
- Generated by (api, admin, system)
- Metadata JSON:
  - Features (maxDevices, canExportData, etc.)
  - Limits (maxUsers, maxAlertRules, etc.)
  - Subscription status
  - Trial mode status
  - Expiration date

### ❌ NOT Stored (Security)

- ❌ Actual JWT license token
- ❌ Private key
- ❌ Customer API keys
- ❌ Stripe payment details

---

## Benefits

1. **Audit Trail**: See when licenses were issued, upgraded, or revoked
2. **Debugging**: If customer has license issue, verify when it was generated
3. **Analytics**: Track plan adoption, upgrade rates
4. **Compliance**: Prove who accessed what features and when
5. **Support**: Help customers troubleshoot license problems

---

## API Endpoints Added

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/licenses/:customerId/history` | GET | Get license history for customer |
| `/api/licenses/history/recent` | GET | Get recent license activity (all customers) |
| `/api/licenses/stats` | GET | Get overall license statistics |

---

## Migration Rollback (If Needed)

```sql
-- Remove audit table
DROP TABLE IF EXISTS license_history;
```

**Note**: This will delete all audit history!

---

## Next Steps

After testing:

1. ✅ Verify audit logging works correctly
2. ✅ Check performance impact (should be minimal)
3. ✅ Add to monitoring dashboard (optional)
4. ✅ Set up alerts for unusual activity (optional)
5. ✅ Create cleanup job for old audit logs (optional, e.g., keep last 2 years)

Example cleanup job:

```sql
-- Delete audit logs older than 2 years (run monthly)
DELETE FROM license_history 
WHERE generated_at < NOW() - INTERVAL '2 years';
```
